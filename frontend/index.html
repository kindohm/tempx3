<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <style>
      [x-cloak] {
        display: none !important;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="//unpkg.com/alpinejs" defer></script>
  </head>
  <body>
    <div class="container" x-data="readingData()" x-init="fetchReadings()">
      <h3>Hank's Weather Station</h3>
      <p>
        Last 50 readings shown. Readings are recorded every hour from a 280BME
        sensor running on a Raspberry Pi.
      </p>
      <p x-show="isLoading">Loading...</p>

      <canvas id="temperatureChart"></canvas>

      <table class="table" x-cloak x-show="!isLoading">
        <tr>
          <th>Date</th>
          <th>Temperature</th>
          <th>Humidity</th>
          <th>Pressure</th>
        </tr>
        <template x-for="reading in readings">
          <tr>
            <td x-text="reading.dateDisplay"></td>
            <td x-text="reading.temperatureDisplay"></td>
            <td x-text="reading.humidityDisplay"></td>
            <td x-text="reading.pressureDisplay"></td>
          </tr>
        </template>
      </table>
    </div>
    <script>
      const readingData = () => {
        return {
          isLoading: true,
          readings: [],
          fetchReadings() {
            fetch("http://104.131.30.210/api/readings")
              .then((response) => response.json())
              .then((data) => {
                const mapped = data.map((reading) => {
                  const { pressure, humidity, createdAt, temperature } =
                    reading;
                  const dt = new Date(createdAt);
                  const celcius = temperature;
                  const farenheit = (celcius * 9) / 5 + 32;
                  return {
                    celcius,
                    farenheit,
                    temperatureDisplay: `${celcius.toFixed(
                      1
                    )} °C / ${farenheit.toFixed(1)} °F`,
                    humidityDisplay: `${humidity.toFixed(1)}%`,
                    dateDisplay: `${dt.toLocaleDateString()} ${dt.toLocaleTimeString()}`,
                    hour: dt.toLocaleTimeString(),
                    pressureDisplay: `${pressure.toFixed(1)} hPa`,
                  };
                });

                const chartsData = mapped.reduce((acc, next, i) => {

                  acc.temperatureChartData.labels.unshift(next.hour);
                  acc.temperatureChartData.data.unshift(next.farenheit);
                  return acc;
                }, {
                  temperatureChartData: {labels: [], data: []}
                });

                this.readings = mapped;
                this.isLoading = false;
                this.renderCharts(chartsData);
              });
          },
          renderCharts(chartsData) {
            let ctx = document
              .getElementById("temperatureChart")
              .getContext("2d");

            let data = chartsData.temperatureChartData.data;
            let labels = chartsData.temperatureChartData.labels;

            let chart = new Chart(ctx, {
              type: "line",
              data: {
                labels,
                datasets: [
                  {
                    label: "",
                    backgroundColor: "rgba(255, 255, 255, 0.1)",
                    borderColor: "rgba(255, 0, 255, 1)",
                    pointBackgroundColor: "rgba(255, 255, 0, 1)",
                    data,
                  },
                ],
              },
              layout: {
                padding: {
                  right: 10,
                },
              },
              options: {
                legend: {
                  display: false,
                },
              },
            });
          },
        };
      };
    </script>
  </body>
</html>
