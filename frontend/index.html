<!DOCTYPE html>
<html>
  <head>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <style>
      [x-cloak] {
        display: none !important;
      }
    </style>
    <script src="//unpkg.com/alpinejs" defer></script>
  </head>
  <body>
    <div class="container" x-data="readingData()" x-init="fetchReadings()">
      <h3>Hank's Weather Station</h3>
      <p>Last 50 readings shown. Readings are recorded every hour from a 280BME sensor
        running on a Raspberry Pi. 
      </p>
      <p x-show="isLoading">Loading...</p>
      <table class="table" x-cloak x-show="!isLoading">
        <tr>
          <th>Date</th>
          <th>Temperature</th>
          <th>Humidity</th>
          <th>Pressure</th>
        </tr>
        <template x-for="reading in readings">
          <tr>
            <td x-text="reading.dateDisplay"></td>
            <td x-text="reading.temperatureDisplay"></td>
            <td x-text="reading.humidityDisplay"></td>
            <td x-text="reading.pressureDisplay"></td>
          </tr>
        </template>
      </table>
    </div>
    <script>
      const readingData = () => {
        return {
          isLoading: true,
          readings: [],
          fetchReadings() {
            fetch("http://104.131.30.210/api/readings")
              .then((response) => response.json())
              .then((data) => {
                const mapped = data.map((reading) => {
                  const { pressure, humidity, createdAt, temperature } =
                    reading;
                  const dt = new Date(createdAt);
                  const celcius = temperature;
                  const farenheit = (celcius * 9) / 5 + 32;
                  return {
                    temperatureDisplay: `${celcius.toFixed(
                      1
                    )} °C / ${farenheit.toFixed(1)} °F`,
                    humidityDisplay: `${humidity.toFixed(1)}%`,
                    dateDisplay: `${dt.toLocaleDateString()} ${dt.toLocaleTimeString()}`,
                    pressureDisplay: `${pressure.toFixed(1)} hPa`,
                  };
                });
                this.isLoading = false;
                this.readings = mapped;
              });
          },
        };
      };
    </script>
  </body>
</html>
